rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- CLUBS ---
    match /clubs/{clubId} {

      // Lire les clubs ‚Üí autoris√© √† tous les utilisateurs connect√©s
      allow read: if request.auth != null;

      // Cr√©er un club ‚Üí autoris√© si l‚Äôutilisateur est connect√©
      allow create: if request.auth != null;

      // Mettre √† jour un club :
      // - le propri√©taire peut modifier
      // - un membre peut mettre √† jour
      // - tout utilisateur connect√© peut modifier uniquement le champ 'members' (pour rejoindre/quitter)
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid in resource.data.members ||
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['members'])
      );

      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
    }

    // ----------------------------------------------------
    // PREUVES
    // ----------------------------------------------------
    match /preuves/{preuveId} {
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId;

      allow read, update: if request.auth != null
        && (
          request.auth.uid == resource.data.userId ||
          resource.data.assignedValidators.hasAny([request.auth.uid])
        );

      allow delete: if false;
    }

    // ----------------------------------------------------
    // USERS + FRIEND SYSTEM
    // ----------------------------------------------------
    match /users/{userId} {

      // üîé Tous les utilisateurs connect√©s peuvent lire les profils
      allow read: if request.auth != null;

      // ‚úèÔ∏è Seul le propri√©taire peut modifier SON doc user
      allow write: if request.auth != null && request.auth.uid == userId;

      // ---------------------------
      // FRIEND REQUESTS SUBCOLLECTION
      // users/{targetId}/friendRequests/{requestId}
      // ---------------------------
      match /friendRequests/{requestId} {

        // üìå Lecture : uniquement le destinataire
        allow read: if request.auth != null && request.auth.uid == userId;

        // ‚úâÔ∏è Cr√©ation par l'exp√©diteur : le champ 'from' doit correspondre √† l'UID authentifi√©
        allow create: if request.auth != null && request.resource.data.from == request.auth.uid && request.resource.data.status == 'pending';

        // ‚òëÔ∏è Accepter / Refuser ‚Üí uniquement par le destinataire
        allow update: if request.auth != null && request.auth.uid == userId;

        // ‚ùå Suppression uniquement par le destinataire (pour nettoyer apr√®s rejet)
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // ---------------------------
      // FRIENDS SUBCOLLECTION
      // users/{uid}/friends/{friendId}
      // ---------------------------
      match /friends/{friendId} {
        // Owner can read their friends
        allow read: if request.auth != null && request.auth.uid == userId;
        // Allow creation by either owner or the counterpart friend (to write symmetric relation)
        allow create: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId);
        // Allow updates from owner or counterpart; deletes remain owner-only
        allow update: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ----------------------------------------------------
    // DEFIS
    // ----------------------------------------------------
    match /defis/{defiId} {
      allow read, write: if request.auth != null;
    }
  }
}
